<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [workshop-lite] rantelope: day 002
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:michal%40sabren.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000005.html">
   <LINK REL="Next"  HREF="000007.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[workshop-lite] rantelope: day 002
   </H1>
    <B>Michal Wallace
    </B> 
    <A HREF="mailto:michal%40sabren.com"
       TITLE="[workshop-lite] rantelope: day 002">michal@sabren.com
       </A><BR>
    <I>Tue, 24 Sep 2002 22:56:09 -0400 (Eastern Daylight Time)</I>
    <P><UL>
        <LI> Previous message: <A HREF="000005.html">[workshop-lite] rantelope: day one
</A></li>
        <LI> Next message: <A HREF="000007.html">[workshop-lite] rantelope day 003: the channel hierarchy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6">[ date ]</a>
              <a href="thread.html#6">[ thread ]</a>
              <a href="subject.html#6">[ subject ]</a>
              <a href="author.html#6">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>rantelope: day 002
------------------

Today I added an XSLT template system to Rantelope.
It wasn't terribly complicated. Most of the work
was just brushing up on my XSLT to get a default
template working.

The new code and live demo are up on:

    <A HREF="http://www.rantelope.com/">http://www.rantelope.com/</A>


==[ today's objective ]==

Since we already had an RSS feed, I thought it would
make sense to generate HTML by transforming the RSS
with XSLT. 

I could have used my own template language (Zebra),
but I want Rantelope to be built on standards, not
my personal whims. Zebra has hardly any documentation,
whereas there are plenty of great resources for 
learning XSLT. 

Using XSLT also means we can potentially reuse the 
templates for RSS feeds generated by *any* blogging 
tool, which is a nice plus.

==[ implementation ]==

Running an XSLT transformation in python is easy,
thanks to the 4Suite library:

   <A HREF="http://4suite.org/index.xhtml">http://4suite.org/index.xhtml</A>

I went ahead and installed 4suite on all cornerhost
machines in case anyone wants to play around with it. 

I wasn't sure how to use it, but a quick google
search saved the day. Uche Ogbuji, the principal
author of 4Suite, has a tutorial for working with
XSLT here:

  <A HREF="http://uche.ogbuji.net:8080/uche.ogbuji.net/tech/akara/pyxml/python-xslt/">http://uche.ogbuji.net:8080/uche.ogbuji.net/tech/akara/pyxml/python-xslt/</A>

Once I read that, invoking a tranformation was easy.
If you're dealing with xml stored in python strings,
it boils down to something like this:

  def transform(xml, xsl): 
       &quot;&quot;&quot; 
       A simple wrapper for 4XSLT. 
       &quot;&quot;&quot; 
       from Ft.Xml.Xslt.Processor import Processor 
       from Ft.Xml.InputSource import DefaultFactory 
       proc = Processor()
       ## @TODO: these fromString() calls should
       ## really include a URI...
       xslObj = DefaultFactory.fromString(xsl) 
       proc.appendStylesheet(xslObj) 
       xmlObj = DefaultFactory.fromString(xml) 
       return proc.run(xmlObj) 


Well, an RSS feed looks something like this:

&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;rss version=&quot;2.0&quot; xmlns=&quot;<A HREF="http://backend.userland.com/rss2"">http://backend.userland.com/rss2&quot;</A>&gt;
  &lt;channel&gt;
    &lt;title&gt;my channel&lt;/title&gt;
    &lt;link&gt;<A HREF="http://rantelope.com/</link">http://rantelope.com/&lt;/link</A>&gt;
    &lt;description&gt;my first channel.&lt;/description&gt;
    &lt;item&gt;
      &lt;title&gt;first post!&lt;/title&gt;
      &lt;link&gt;<A HREF="http://rantelope.com/</link">http://rantelope.com/&lt;/link</A>&gt;
      &lt;description&gt;rantelope rules!&lt;/description&gt;
    &lt;/item&gt;
  &lt;/channel&gt;
&lt;/rss&gt;

I was missing the &lt;channel&gt; tag yesterday, but once I fixed
that, it just took a little reading to put together a default
XSLT template. It looked something like this:

plainXSLT =\
'''\
&lt;xsl:stylesheet version=&quot;1.0&quot;
   xmlns:rss=&quot;<A HREF="http://backend.userland.com/rss2"">http://backend.userland.com/rss2&quot;</A>
   xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform"">http://www.w3.org/1999/XSL/Transform&quot;</A>&gt;
   &lt;xsl:template match=&quot;rss:channel&quot;&gt;
     &lt;html&gt;
       &lt;head&gt;
         &lt;title&gt;&lt;xsl:value-of select=&quot;rss:title&quot;/&gt;&lt;/title&gt;
       &lt;/head&gt;
       &lt;body&gt;
         &lt;h1&gt;&lt;xsl:value-of select=&quot;rss:title&quot;/&gt;&lt;/h1&gt;
         &lt;p&gt;&lt;i&gt;&lt;xsl:value-of select=&quot;rss:description&quot;/&gt;&lt;/i&gt;&lt;/p&gt;
         &lt;xsl:for-each select=&quot;rss:item&quot;&gt;
            &lt;div class=&quot;post&quot;&gt;
              &lt;h2&gt;&lt;xsl:value-of select=&quot;rss:title&quot;/&gt;&lt;/h2&gt;
              &lt;xsl:value-of select=&quot;rss:description&quot;/&gt;
            &lt;/div&gt;
         &lt;/xsl:for-each&gt;
       &lt;/body&gt;
     &lt;/html&gt;
   &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
'''

Making that the default involved several steps.
First, I had to add a .template field to the Channel 
class. It uses the &quot;default&quot; option of the 
strongbox.attr() type:

class Channel(Strongbox):
    # ...
    template = attr(str, default=plainXSLT)


Second, I had to add a &quot;template&quot; field to my table
in MySQL.

Finally, I updated all the existing records to use the 
new template:

     for c in CLERK.match(Channel):
         c.template = plainXSLT
         c.writeFiles()
         CLERK.store(c)


The writeFiles() function is also new. Now that I want
to write HTML as well as RSS, it made sense to refactor
things a bit. So we now have:

class Channel(Strongbox):
    #...
    def toRSS(self):
        return zebra.fetch(&quot;rss&quot;, BoxView(self))

    def toHTML(self, input=None):
        rss = input or self.toRSS()
        return transform(rss, self.template)

    def writeFiles(self):
        rss = self.toRSS()
        print &gt;&gt; open(self.path + self.rssfile, &quot;w&quot;), rss
        if self.template:
            print &gt;&gt; open(self.path + self.htmlfile, &quot;w&quot;), self.toHTML(rss)


I did make one other change: I wanted to keep people from
changing the output filename to something like &quot;rantelope.app&quot;,
which could possibly overwrite the actual rantelope application -
a HUGE security flaw! :)

So I hard-coded the output directory to &quot;./out/&quot; and
added a validation rule to the .rssfile and .htmlfile
attributes:

class Channel(Strongbox):
    #...
    rssfile = attr(str, okay=lambda x: &quot;/&quot; not in x and x.endswith(&quot;.rss&quot;))
    htmlfile = attr(str, okay=lambda x: &quot;/&quot; not in x and x.endswith(&quot;.html&quot;))


The &quot;okay&quot; option also accepts regular expressions, so I might
use those in the future instead of these long, ugly lambdas. 
(Lambdas are a way of writing really short python functions 
on the fly.)

Now if you try and input an invalid filename, you'll get a nasty
error screen. Eventually, it'll be a nicely formatted error
message, of course.

That's pretty much it for today. Tomorrow, I'm going to expand
rantelope from just a blogging tool to a true content management
system capable of managing an entire website.

-----

PS: I tried to make this one a little more &quot;skimmable&quot;, and
not force people to go hunt down the code... Is this better?

Sincerely,

Michal J Wallace
Sabren Enterprises, Inc.
-------------------------------------
contact: <A HREF="mailto:michal@sabren.com">michal@sabren.com</A>
hosting: <A HREF="http://www.cornerhost.com/">http://www.cornerhost.com/</A>
my site: <A HREF="http://www.sabren.net/">http://www.sabren.net/</A>
--------------------------------------


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000005.html">[workshop-lite] rantelope: day one
</A></li>
	<LI> Next message: <A HREF="000007.html">[workshop-lite] rantelope day 003: the channel hierarchy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6">[ date ]</a>
              <a href="thread.html#6">[ thread ]</a>
              <a href="subject.html#6">[ subject ]</a>
              <a href="author.html#6">[ author ]</a>
         </LI>
       </UL>
</body></html>
