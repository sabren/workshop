<trail>

<title>entries: a naive implementation</title>

<summary>
In which we create simple blogging tool using plain old SQL.
</summary>

<goal>Define the Shape of the Data</goal>

<p>In SQL, this is done with a create table statement.</p>

<pre>
CREATE TABLE entry (
    ID INTEGER PRIMARY KEY,
    posted datetime,
    title text,
    content text,    
)
</pre>

<goal>Show an Empty Record List</goal>

<pre>
cur.execute("SELECT ID, posted, title, content FROM entry ORDER by posted")
return Model({
   "entries": [
         {"ID":ID, "posted":posted, "title": title, "content": content}
	 for (ID, posted, title, content) in cur.fetchall()]
})
</pre>


<p>and to show it:</p>

<pre>
<html>
<head>
<title>my blog</title></title>
</head>
<body>
<h1>my blog</h1>
* exec:
    prevdate = None

* for series="entries":
    * if posted  != prevdate:
        <h2>{:posted:}</h2>
        * exec:
            prevdate = posted
    <h3><a href="edit?ID={:ID:}">{:title:}</a></h3>
    <div class="entry">{:content:}</div>
</body>
</html>

</pre>

<todo>use reptile instead of zebra</todo>


<goal>Create a Form for Adding Records</goal>

<pre>
<html>
<head>
<title>add/edit entry</title></title>
</head>
<body>
* if ID:
    <h1>edit entry</h1>
* el:
    <h1>add new entry</h1>

<a href=""></a>

* for series="entries":
    * if posted  != prevdate:
        <h2>{:posted:}</h2>
        * exec:
            prevdate = posted
    <h3>{:title:}</h3>
    <div class="entry">{:content:}</div>
</body>
</html>

</pre>

<goal>Save the Form Data</goal>

<todo>move sqlEscape to own article... first part of storage</todo>

<pre>
# unravelled from MySQLStorage._toSQLString(self, val)
def sqlEscapeValue(val):
    asString = unicode(val)
    splitQuotes = asString.split("'")
    fixedQuotes =  "''".join(splitQuotes)
    return "'%s'" % fixedQuotes

def sqlValue(val):
    if val is None:
        return "NULL"
    else:
        return sqlEscapeValue(val)
</pre>


<p>To save our records, we'll use the <code>REPLACE INTO</code>
statement. Not all databases support this and it may be 
slightly slower than an INSERT or UPDATE statement but
it simplifies our code here so we'll use it for now. 
(Otherwise we'd have to write one version for INSERT 
and another for UPDATE)</p>

<todo>link to storage implementation of INSERT/UPDATE</todo>

<pre>
def saveEntry(ID, posted, title, content):
    cur.execute(
        """
	REPLACE INTO entry (ID, posted, title, content) 
	VALUES (%s, %s, %s, %s)
	""" % (sqlValue(ID),
               sqlValue(posted),
               sqlValue(title), 
               sqlValue(content)))
</pre>


<goal>Show/Edit a Record</goal>




<goal>Delete a Record</goal>


<pre>
</pre>

</trail>